name = "constellation"
main = "src/index.ts"
account_id = "d566e3c491e1cef6c530d45b76672814"
workers_dev = false
compatibility_date = "2025-05-01"
compatibility_flags = ["nodejs_als"]

# Queue consumer configuration
[[queues.consumers]]
queue = "new-content-constellation"
max_batch_size = 5  # Reduced from 10 to prevent memory issues
max_batch_timeout = 5
max_retries = 3
max_concurrency = 3  # Reduced to lower concurrent processing
dead_letter_queue = "embed-dead-letter"

# Dead letter queue consumer
[[queues.consumers]]
queue = "embed-dead-letter"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 0  # No automatic retries, we handle retries in the consumer
max_concurrency = 2
# No dead letter queue for the dead letter queue

# Dead letter queue producer
[[queues.producers]]
binding = "EMBED_DEAD"
queue = "embed-dead-letter"

# Vectorize binding
[[vectorize]]
binding = "VECTORIZE"
index_name = "dome-notes"

# Workers AI binding
[ai]
binding = "AI"

# Service binding for Silo
[[services]]
binding = "SILO"
service = "silo"

# For local development
[dev]
port = 8788
local_protocol = "https"

[vars]
VERSION = "1.0.0"
LOG_LEVEL = "debug"

[observability]
enabled = true
head_sampling_rate = 1 # optional. default = 1.
