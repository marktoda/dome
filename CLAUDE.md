# CLAUDE.md - Best Practices for Working with This Repository

> **Note**: This file serves as the master configuration for AI assistants working with this repository. Other files like `.cursorrules` and `AGENTS.md` should reference or symlink to this file to avoid duplication.

## Repository Structure

This repository is organized as a monorepo with the following structure:

### Project State

- this is an **undeployed development project**
- Do not worry about backwards compatibility, deleting outdated files etc.
- when refactoring code, always clean up the old code
- focus heavily on creating simple, readable and extensible code
- the common/ package has all errors and middleware for api handlers
- to update common packages in a service you need to pnpm i and pnpm build
- we do not use `fetch` for inter-service communication -- only direct cloudflare worker RPC

### Core Directories

- `services/` - Contains individual microservices
  - `ai-processor/` - AI processing service
  - `auth/` - Authentication service
  - `chat/` - Chat and RAG service
  - `constellation/` - Embedding service
  - `dome-api/` - Main API gateway
  - `silo/` - Content storage service
  - `todos/` - Todo management service
  - `tsunami/` - Data ingestion service
- `packages/` - Shared packages and libraries
  - `common/` - Common utilities and shared code
- `infra/` - Infrastructure as code and deployment configurations
- `templates/` - Templates for creating new services and workers
  - `sdk-package/` - Template for SDK packages
- `docs/` - Project documentation
- `ui/` - Frontend Next.js application

## Repository Navigation

- This is a monorepo with multiple projects in different directories
- Always verify your current location with `pwd` before executing commands
- Navigate to specific project directories with `cd path/to/directory` before running commands
- Use absolute paths when possible for clarity and reliability
- Use relative paths only when necessary to reference files in other parts of the repository
- Use the directory structure to understand the relationships between services and packages
- Keep the root directory as clean as possible
- Put service-specific tests in the relevant service directory

## pnpm Workspace Setup

- This repository uses pnpm workspaces for managing dependencies
- The workspace configuration is defined in `pnpm-workspace.yaml`
- To install all dependencies across the workspace: `pnpm install`
- To add a dependency to a specific package: `pnpm add <package> --filter <workspace-package>`
- To add a dependency to all packages: `pnpm add -w <package>`
- To run a script in a specific package: `pnpm --filter <workspace-package> <script>`
- To run the same script across all packages: `pnpm -r <script>`

## TypeScript Configuration

- The repository uses TypeScript for type safety and better developer experience
- Root `tsconfig.json` provides base configuration
- Each service and package has its own `tsconfig.json` that extends the root configuration
- Common TypeScript settings are shared across the workspace
- For service-specific TypeScript configurations, check the respective `tsconfig.json` files
- When creating new services, use the TypeScript templates in the `templates/` directory
- Ensure consistent TypeScript version usage across all packages

## Preferred Tooling

- Use Wrangler CLI commands directly instead of pnpm scripts
- Use autogenerated cloudflare types (generated by `wrangler types`) and native WorkerEntrypoint from cloudflare:workers
- opt for RPC style inter-service interactions instead of http fetch
- wrangler.toml compatibility version 2025-04-15
- Example: `wrangler deploy` rather than `pnpm run deploy`
- Use pnpm for package management and script execution
- Use TypeScript for type-safe development
- Follow the established patterns in existing services and packages
- Use drizzle ORM native queries where possible

## Hono Integration

- This repository uses Hono framework for building web applications
- Hono is particularly well-suited for Cloudflare Workers
- Reference `docs/hono-integration.md` for detailed guidance
- Key Hono practices:
  - Use middleware for cross-cutting concerns
  - Leverage Hono's routing capabilities for clean API design
  - Use Hono's type-safe request/response handling
  - Follow the established patterns in existing services
  - Utilize Zod and Hono zValidator built-in validation and error handling

## Common Workflows

- When deploying: first navigate to the project directory, then run Wrangler commands
- For testing: ensure you're in the correct directory before running test suites
- Use vitest for testing
- Creating a new service:
  1. Use the appropriate template from `templates/`
  2. Update the service configuration
  3. Add the service to the pnpm workspace
  4. Implement the service logic
  5. Add tests
  6. Update CI/CD configuration if necessary
- Updating shared packages:
  1. Make changes in the appropriate package
  2. Run tests to ensure compatibility
  3. Update version according to semver
  4. Update dependent services if necessary

## justfile Commands

- This repository uses `just` for defining and running common commands
- The `justfile` contains predefined commands for various tasks
- Common just commands:
  - `just build` - Build all services
  - `just build-no-install` - Build without running `pnpm install`
  - `just build-pkg <pkg>` - Build a specific service
  - `just test` - Run tests for all services
  - `just test-pkg <pkg>` - Run tests for a specific service
  - `just lint` - Check code style (`just lint-fix` to auto-fix)
  - `just lint-pkg <pkg>` - Lint only a single package
  - `just deploy` - Deploy all services
  - `just new-service <name>` - Create a new service from template
  - `just new-worker <name>` - Create a new Rust worker from template
- Run `just --list` to see all available commands
- Prefer using just commands for standardized workflows

## Coding Guidelines

- Keep the code simple, readable and well-typed
- Prefer RPC bindings over HTTP fetches for inter-service calls
- Follow the established error handling and logging patterns from `@dome/common`
- Use the Hono framework for APIs and zValidator/Zod for validation
- Add tests for new features and run them before committing
- Commit messages must follow [Conventional Commits](https://www.conventionalcommits.org/)
- Files should be modular and maintainable (avoid very large files)
- Never hardcode sensitive information (API keys, credentials)
- Use environment variables for configuration

## CI/CD Workflows

- CI/CD is configured in `.github/workflows/ci.yml`
- The CI pipeline includes:
  - Dependency installation
  - Type checking
  - Linting
  - Testing
  - Building
  - Deployment (for specific branches)
- Pull requests trigger CI checks but not deployments
- Merges to main branch trigger both CI checks and deployments
- Environment variables are managed through GitHub Secrets
- Different environments (dev, staging, prod) have different deployment configurations
- Reference the CI/CD configuration for specific workflow details

## Pull Requests

- Branch from `main` and keep changes focused on a single concern
- Ensure `just build-no-install` (or `just build`), `just lint`, and `just test` all succeed before opening a PR
- Update documentation when behavior or APIs change
- Ensure all tests pass before submitting a pull request
- Update documentation when making significant changes
- Add tests for new features and bug fixes
- Keep pull requests focused on a single concern
- Rebase feature branches on main before submitting pull requests
- Use the pull request template for new pull requests
- Request reviews from appropriate team members
- Address all review comments before merging

## Troubleshooting

- If commands fail, first verify you're in the correct directory
- Check Wrangler configuration files are properly set up for the specific project
- Common issues:
  - Missing dependencies: run `pnpm install`
  - TypeScript errors: check the specific error and fix type issues
  - Wrangler configuration: ensure account ID and other settings are correct
  - pnpm workspace issues: check `pnpm-workspace.yaml` for correct configuration
  - Rust compilation errors: check Rust version and dependencies
- Check logs in Cloudflare dashboard for deployed workers
- Use `wrangler tail` to stream logs from deployed workers

## Environment Setup

- Ensure Wrangler CLI is installed globally or available in your PATH
- Configure environment variables as needed for different deployment targets
- Required tools:
  - Node.js (LTS version recommended)
  - pnpm (latest version)
  - Wrangler CLI
  - Rust toolchain (for Rust workers)
  - just command runner
- Local development:
  - Use `.dev.vars` files for local environment variables
  - Use `wrangler dev` for local development of workers
  - Use appropriate local development commands for services

## Security Considerations

- Do not commit sensitive information (API keys, credentials)
- Use environment variables for sensitive configuration
- Follow least privilege principle for worker permissions
- Keep dependencies updated to avoid security vulnerabilities
- Run security scans regularly
- Follow Cloudflare Workers security best practices
- Use proper authentication and authorization in services
- Configure sensitive data via environment variables or `.dev.vars` files

## Quick Reference for AI Assistants

For a concise overview of this repository, see `AGENTS.md` which provides a condensed version of these guidelines focused on the most common workflows and practices.