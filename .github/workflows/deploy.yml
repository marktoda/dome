name: Deploy changed Cloudflare workers

on:
  push:
    branches: [ main ]
  pull_request:
    paths:
      - 'services/**'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: list_dirs
        run: |
          echo "dirs=$(ls -1 services | tr '\n' ' ')" >> "$GITHUB_OUTPUT"
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.event.pull_request.base.sha || 'origin/main' }}
          filters: |
            {% for d in steps.list_dirs.outputs.dirs.split(' ') %}
            {{ d }}:
              - 'services/{{ d }}/**'
            {% endfor %}

  deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.any_changed == 'true'
    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.changed_names) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm install -g wrangler@latest
      - name: Deploy ${{ matrix.service }}
        working-directory: services/${{ matrix.service }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: wrangler deploy --env production
